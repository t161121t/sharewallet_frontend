# 13. 支出の編集・削除 — 実装手順

> 未実装機能一覧 `#3` に対応。5段階で実装する。

---

## 前提

### 現在の実装状況

- `GET /api/groups/:groupId/expenses` — 支出一覧取得（実装済み）
- `POST /api/groups/:groupId/expenses` — 支出登録（実装済み）
- 支出履歴画面（`/expense/history`）に日付別の支出一覧を表示中（実装済み）
- 支出入力画面（`/expense`）で新規登録が可能（実装済み）
- Prisma スキーマに `Expense` モデルあり（変更不要）

### 完成後の動作イメージ

**編集：**
1. 支出履歴画面で支出アイテムをタップする
2. 編集モーダル（またはインライン編集）が開く
3. カテゴリ・金額・メモを変更して「保存」を押す
4. API で支出が更新され、一覧に反映される

**削除：**
1. 支出アイテムを左スワイプ、またはモーダル内の「削除」ボタンをタップ
2. 確認ダイアログが表示される
3. 「削除」を確定すると API で支出が削除され、一覧から消える

---

## Stage 1: API エンドポイントの実装（PUT / DELETE）

### 目的

個別の支出を更新・削除する API を追加する。

### 作成するファイル

| 種別 | パス |
|------|------|
| 新規 | `src/app/api/groups/[groupId]/expenses/[expenseId]/route.ts` |

### 実装内容

1. **`PUT` ハンドラ（支出の更新）**
   - `getAuthUserId(req)` で認証チェック
   - パスパラメータから `groupId`, `expenseId` を取得
   - リクエストボディから更新対象フィールドを取得（`category`, `amount`, `memo`）
   - 対象の支出が存在し、かつ指定したグループに属していることを確認
   - Prisma の `update` で更新
   ```typescript
   export async function PUT(
     req: NextRequest,
     { params }: { params: Promise<{ groupId: string; expenseId: string }> }
   ) {
     const userId = await getAuthUserId(req);
     if (!userId) {
       return NextResponse.json<ApiError>(
         { error: "認証が必要です" },
         { status: 401 }
       );
     }

     const { groupId, expenseId } = await params;
     const body = await req.json().catch(() => null);

     if (!body) {
       return NextResponse.json<ApiError>(
         { error: "リクエストボディが不正です" },
         { status: 400 }
       );
     }

     // 支出の存在確認 + グループ所属確認
     const existing = await prisma.expense.findFirst({
       where: { id: expenseId, groupId },
     });

     if (!existing) {
       return NextResponse.json<ApiError>(
         { error: "支出が見つかりません" },
         { status: 404 }
       );
     }

     const expense = await prisma.expense.update({
       where: { id: expenseId },
       data: {
         ...(body.category !== undefined && { category: body.category }),
         ...(body.amount !== undefined && { amount: body.amount }),
         ...(body.memo !== undefined && { memo: body.memo || null }),
       },
       include: {
         member: { select: { id: true, name: true } },
       },
     });

     const result: ExpenseRecord = {
       id: expense.id,
       category: expense.category as ExpenseRecord["category"],
       amount: expense.amount,
       memberId: expense.member.id,
       memberName: expense.member.name,
       memo: expense.memo ?? undefined,
       date: expense.date.toISOString(),
     };

     return NextResponse.json<ExpenseRecord>(result);
   }
   ```

2. **`DELETE` ハンドラ（支出の削除）**
   ```typescript
   export async function DELETE(
     req: NextRequest,
     { params }: { params: Promise<{ groupId: string; expenseId: string }> }
   ) {
     const userId = await getAuthUserId(req);
     if (!userId) {
       return NextResponse.json<ApiError>(
         { error: "認証が必要です" },
         { status: 401 }
       );
     }

     const { groupId, expenseId } = await params;

     // 支出の存在確認 + グループ所属確認
     const existing = await prisma.expense.findFirst({
       where: { id: expenseId, groupId },
     });

     if (!existing) {
       return NextResponse.json<ApiError>(
         { error: "支出が見つかりません" },
         { status: 404 }
       );
     }

     await prisma.expense.delete({
       where: { id: expenseId },
     });

     return NextResponse.json({ message: "削除しました" });
   }
   ```

### 確認ポイント

- [ ] `PUT /api/groups/:groupId/expenses/:expenseId` で支出が更新される
- [ ] `DELETE /api/groups/:groupId/expenses/:expenseId` で支出が削除される
- [ ] 存在しない `expenseId` に対して 404 が返る
- [ ] 認証なしで 401 が返る

---

## Stage 2: API クライアントに関数を追加

### 目的

フロントエンドから支出の更新・削除 API を呼べるようにする。

### 修正するファイル

| 種別 | パス |
|------|------|
| 修正 | `src/lib/apiClient.ts` |
| 修正 | `src/types/index.ts` |

### 実装内容

1. **型定義の追加**（`src/types/index.ts`）
   ```typescript
   /** 支出更新リクエスト */
   export type UpdateExpenseRequest = {
     category?: CategoryName;
     amount?: number;
     memo?: string;
   };

   /** 削除レスポンス */
   export type DeleteResponse = {
     message: string;
   };
   ```

2. **apiClient に関数を追加**
   ```typescript
   /** 支出を更新 */
   export async function updateExpense(
     groupId: string,
     expenseId: string,
     data: UpdateExpenseRequest
   ): Promise<ExpenseRecord> {
     return apiFetch<ExpenseRecord>(
       `/api/groups/${groupId}/expenses/${expenseId}`,
       {
         method: "PUT",
         body: JSON.stringify(data),
       }
     );
   }

   /** 支出を削除 */
   export async function deleteExpense(
     groupId: string,
     expenseId: string
   ): Promise<void> {
     await apiFetch<DeleteResponse>(
       `/api/groups/${groupId}/expenses/${expenseId}`,
       { method: "DELETE" }
     );
   }
   ```

### 確認ポイント

- [ ] `updateExpense(groupId, expenseId, { amount: 5000 })` が正常に動作する
- [ ] `deleteExpense(groupId, expenseId)` が正常に動作する
- [ ] TypeScript の型チェックが通る

---

## Stage 3: 編集モーダルコンポーネントの作成

### 目的

支出を編集するためのモーダル UI を共通コンポーネントとして作成する。

### 作成するファイル

| 種別 | パス |
|------|------|
| 新規 | `src/components/ui/ExpenseEditModal.tsx` |

### 実装内容

1. **Props の定義**
   ```typescript
   type Props = {
     expense: ExpenseRecord | null;  // null の場合はモーダルを非表示
     onClose: () => void;
     onSave: (data: UpdateExpenseRequest) => Promise<void>;
     onDelete: () => Promise<void>;
   };
   ```

2. **モーダルのレイアウト**
   - **オーバーレイ**: 半透明黒背景、クリックで閉じる
   - **モーダル本体**: 画面下部からスライドイン（`framer-motion` の `AnimatePresence`）
   - フォーム内容:
     - `GenreSelect` でカテゴリ選択（初期値: 現在のカテゴリ）
     - 金額入力（初期値: 現在の金額）
     - メモ入力（初期値: 現在のメモ）
   - ボタン:
     - 「保存」: `PrimaryButton`（ローディング対応）
     - 「削除」: 赤テキストのボタン
     - 「キャンセル」: グレーテキストのボタン

3. **状態管理**
   - `category`, `amount`, `memo` をローカル state で管理
   - `expense` が変わったら state をリセット（`useEffect`）
   - `savingLoading`, `deletingLoading` でそれぞれのローディング状態を管理

4. **アニメーション**
   ```typescript
   <motion.div
     initial={{ y: "100%" }}
     animate={{ y: 0 }}
     exit={{ y: "100%" }}
     transition={{ type: "spring", damping: 25 }}
   >
   ```

### 確認ポイント

- [ ] `expense` が渡されるとモーダルが表示される
- [ ] `null` を渡すとモーダルが閉じる
- [ ] カテゴリ・金額・メモの初期値が正しくセットされる
- [ ] 「保存」「削除」「キャンセル」ボタンが機能する
- [ ] モーダルのスライドインアニメーションが動く

---

## Stage 4: 支出履歴画面に編集・削除機能を統合

### 目的

支出履歴画面（`/expense/history`）に編集モーダルを組み込み、支出の更新・削除ができるようにする。

### 修正するファイル

| 種別 | パス |
|------|------|
| 修正 | `src/app/expense/history/page.tsx` |

### 実装内容

1. **import の追加**
   ```typescript
   import ExpenseEditModal from "@/components/ui/ExpenseEditModal";
   import {
     updateExpense,
     deleteExpense,
     ApiClientError,
   } from "@/lib/apiClient";
   import toast from "react-hot-toast";
   ```

2. **状態の追加**
   ```typescript
   const [editingExpense, setEditingExpense] = useState<ExpenseRecord | null>(null);
   ```

3. **`ExpenseItem` をクリック可能にする**
   - 既存の `ExpenseItem` コンポーネントに `onClick` prop を追加
   - クリック時に `setEditingExpense(expense)` でモーダルを開く
   - `cursor-pointer` + ホバースタイルを追加

4. **保存ハンドラ**
   ```typescript
   const handleSave = async (data: UpdateExpenseRequest) => {
     if (!editingExpense || !group) return;
     try {
       const updated = await updateExpense(group.id, editingExpense.id, data);
       setExpenses((prev) =>
         prev.map((e) => (e.id === updated.id ? updated : e))
       );
       setEditingExpense(null);
       toast.success("支出を更新しました");
     } catch (e) {
       if (e instanceof ApiClientError) toast.error(e.message);
       else toast.error("更新に失敗しました");
     }
   };
   ```

5. **削除ハンドラ**
   ```typescript
   const handleDelete = async () => {
     if (!editingExpense || !group) return;
     try {
       await deleteExpense(group.id, editingExpense.id);
       setExpenses((prev) =>
         prev.filter((e) => e.id !== editingExpense.id)
       );
       setEditingExpense(null);
       toast.success("支出を削除しました");
     } catch (e) {
       if (e instanceof ApiClientError) toast.error(e.message);
       else toast.error("削除に失敗しました");
     }
   };
   ```

6. **モーダルの配置**
   - ページの最下部に `ExpenseEditModal` を配置
   ```tsx
   <ExpenseEditModal
     expense={editingExpense}
     onClose={() => setEditingExpense(null)}
     onSave={handleSave}
     onDelete={handleDelete}
   />
   ```

### 確認ポイント

- [ ] 支出アイテムをタップするとモーダルが開く
- [ ] モーダルで値を変更して「保存」すると一覧に反映される
- [ ] 「削除」を押すと確認後に一覧から消える
- [ ] サマリーカード（合計・1人あたり・件数）が即時更新される
- [ ] エラー時にトーストが表示される

---

## Stage 5: 削除の確認ダイアログと仕上げ

### 目的

誤操作を防ぐ確認ダイアログの追加と、全体的な UX の仕上げを行う。

### 作成・修正するファイル

| 種別 | パス |
|------|------|
| 新規 | `src/components/ui/ConfirmDialog.tsx` |
| 修正 | `src/components/ui/ExpenseEditModal.tsx` |
| 修正 | `src/app/expense/history/page.tsx` |

### 実装内容

1. **確認ダイアログコンポーネント**（`ConfirmDialog.tsx`）
   ```typescript
   type Props = {
     open: boolean;
     title: string;
     message: string;
     confirmLabel?: string;   // デフォルト: "削除"
     confirmColor?: string;   // デフォルト: "#EF4444"（赤）
     onConfirm: () => void;
     onCancel: () => void;
   };
   ```
   - `AnimatePresence` でフェードイン/アウト
   - 中央にカード表示（タイトル + メッセージ + ボタン2つ）
   - 「キャンセル」と「削除」ボタン

2. **`ExpenseEditModal` に確認ダイアログを統合**
   - 「削除」ボタン押下時に即削除ではなく、`ConfirmDialog` を表示
   - 確認後に `onDelete` を呼び出す

3. **UX の仕上げ**
   - 支出履歴の各アイテムに右端に「＞」シェブロンを追加（タップ可能であることを視覚的に示す）
   - モーダルを閉じた後のフォーカス管理
   - 削除後にサマリーカードの金額が即時更新されることを確認

4. **空状態の対応**
   - 全件削除した場合に「支出がありません」メッセージを表示

### 確認ポイント

- [ ] 「削除」タップで確認ダイアログが表示される
- [ ] 「キャンセル」でダイアログが閉じ、支出は残る
- [ ] 「削除」確定で支出が削除される
- [ ] 支出アイテムにタップ可能なビジュアルヒントがある
- [ ] 全件削除後に空状態メッセージが表示される
- [ ] `ConfirmDialog` は他の機能でも再利用可能

---

## 実装フロー図

```
Stage 1          Stage 2          Stage 3          Stage 4          Stage 5
API 実装    →    クライアント  →  モーダル作成  →  履歴画面統合  →  仕上げ
                 関数追加

PUT/DELETE       updateExpense()  ExpenseEdit      クリック →       ConfirmDialog
/expenses/       deleteExpense()  Modal.tsx        モーダル表示      + シェブロン
[expenseId]      + 型定義        カテゴリ/金額/    保存/削除         + 空状態
route.ts                         メモの編集UI      ハンドラ          + フォーカス
```

---

## API 仕様（追加分）

### PUT `/api/groups/:groupId/expenses/:expenseId`

支出を更新する。

**認証:** 必要

**リクエストボディ（全フィールド任意、送信したフィールドのみ更新）**
```json
{
  "category": "食費",
  "amount": 5000,
  "memo": "ランチ代（修正）"
}
```

**成功 `200`**
```json
{
  "id": "e1",
  "category": "食費",
  "amount": 5000,
  "memberId": "u1",
  "memberName": "田中",
  "memo": "ランチ代（修正）",
  "date": "2026-01-31T18:30:00.000Z"
}
```

**エラー `404`**
```json
{ "error": "支出が見つかりません" }
```

### DELETE `/api/groups/:groupId/expenses/:expenseId`

支出を削除する。

**認証:** 必要

**成功 `200`**
```json
{ "message": "削除しました" }
```

**エラー `404`**
```json
{ "error": "支出が見つかりません" }
```

---

## 関連ドキュメント

- 現在の API 仕様: `07-API仕様書.md`
- DB スキーマ: `prisma/schema.prisma`（変更不要）
- 未実装機能一覧: `11-未実装機能一覧.md`
