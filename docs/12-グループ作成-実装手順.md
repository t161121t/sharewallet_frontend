# 12. グループ作成 — 実装手順

> 未実装機能一覧 `#2` に対応。5段階で実装する。

---

## 前提

### 現在の実装状況

- `GET /api/groups` — グループ一覧取得（実装済み）
- `GET /api/groups/:groupId` — グループ詳細取得（実装済み）
- ダッシュボード（`/dashboard`）にグループ一覧を表示中（実装済み）
- Prisma スキーマに `Group`, `GroupMember` モデルあり（変更不要）

### 完成後の動作イメージ

1. ダッシュボードに「＋ グループを作成」ボタンが表示される
2. ボタンを押すとグループ作成画面（`/groups/new`）に遷移する
3. グループ名とテーマカラーを入力して「作成」を押す
4. API でグループが作成され、作成者が自動的にメンバーとして追加される
5. 作成完了後、ダッシュボードに戻り新しいグループが一覧に表示される

---

## Stage 1: API エンドポイントの実装

### 目的

`POST /api/groups` を新規作成し、グループの作成処理を実装する。

### 作成するファイル

| 種別 | パス |
|------|------|
| 修正 | `src/app/api/groups/route.ts`（既存の GET に POST を追加） |

### 実装内容

1. **`POST` ハンドラを追加**
   - `getAuthUserId(req)` で認証チェック（401 エラー）
   - リクエストボディから `name`（必須）、`color`（任意、デフォルト `#c9a227`）を取得
   - `name` が空の場合 400 エラーを返す

2. **Prisma でグループとメンバーを同時作成**
   ```typescript
   const group = await prisma.group.create({
     data: {
       name: body.name,
       color: body.color ?? "#c9a227",
       members: {
         create: { userId },   // 作成者を自動追加
       },
     },
     include: {
       members: {
         include: {
           user: { select: { id: true, name: true, color: true } },
         },
       },
     },
   });
   ```

3. **レスポンス**
   - 成功時: `201` + `Group` 型の JSON
   - レスポンスの整形は既存の `GET` と同じパターンを使う

### 確認ポイント

- [ ] `POST /api/groups` にグループ名を送ると新しいグループが作成される
- [ ] 作成者が自動的にメンバーに追加される
- [ ] 認証なしのリクエストで 401 が返る
- [ ] `name` 未指定で 400 が返る

---

## Stage 2: API クライアントに関数を追加

### 目的

フロントエンドから `POST /api/groups` を呼べるようにする。

### 修正するファイル

| 種別 | パス |
|------|------|
| 修正 | `src/lib/apiClient.ts` |
| 修正 | `src/types/index.ts` |

### 実装内容

1. **型定義の追加**（`src/types/index.ts`）
   ```typescript
   /** グループ作成リクエスト */
   export type CreateGroupRequest = {
     name: string;
     color?: string;
   };
   ```

2. **apiClient に `createGroup` 関数を追加**
   ```typescript
   export async function createGroup(
     data: CreateGroupRequest
   ): Promise<Group> {
     return apiFetch<Group>("/api/groups", {
       method: "POST",
       body: JSON.stringify(data),
     });
   }
   ```

### 確認ポイント

- [ ] `createGroup({ name: "テスト" })` を呼び出して正常にレスポンスが返る
- [ ] TypeScript の型チェックが通る

---

## Stage 3: グループ作成画面の UI を実装

### 目的

新しいページ `/groups/new` にグループ作成フォームを作成する。

### 作成するファイル

| 種別 | パス |
|------|------|
| 新規 | `src/app/groups/new/page.tsx` |

### 実装内容

1. **クライアントコンポーネント**
   - `"use client"` を付与
   - 認証チェック（`isAuthenticated()` → 未認証なら `/login` へリダイレクト）

2. **状態管理**
   - `groupName: string`（グループ名）
   - `groupColor: string`（テーマカラー、デフォルト `#c9a227`）
   - `loading: boolean`（送信中フラグ）
   - `error: string`（バリデーションエラー）

3. **レイアウト（上から順）**
   - `ScreenContainer` + `PageTransition` でラップ
   - ヘッダー: 「← 戻る」リンク（`/dashboard` へ）+ ページタイトル「グループを作成」
   - 入力1: `TextInput`（グループ名、必須、placeholder: 「グループ名を入力」）
   - 入力2: カラーピッカー（プリセット色 6〜8 色を丸ボタンで表示）
   - プレビュー: 入力した名前と色でグループカードのプレビューを表示
   - `PrimaryButton`（「作成する」、`loading` 対応）

4. **カラーピッカーのプリセット色**
   ```typescript
   const PRESET_COLORS = [
     "#c9a227", "#3B82F6", "#EC4899", "#10B981",
     "#6366F1", "#F43F5E", "#F59E0B", "#8B5CF6",
   ];
   ```

5. **バリデーション**
   - グループ名が空の場合はエラー表示
   - グループ名の最大文字数: 30 文字

### 確認ポイント

- [ ] `/groups/new` にアクセスするとフォームが表示される
- [ ] グループ名を入力するとプレビューに反映される
- [ ] プリセット色を選択するとプレビューの色が変わる
- [ ] 未認証時に `/login` にリダイレクトされる

---

## Stage 4: グループ作成の送信処理

### 目的

フォーム送信で API を呼び出し、グループ作成を完了させる。

### 修正するファイル

| 種別 | パス |
|------|------|
| 修正 | `src/app/groups/new/page.tsx`（Stage 3 で作成済み） |

### 実装内容

1. **`handleCreate` 関数を実装**
   ```typescript
   const handleCreate = async () => {
     if (!groupName.trim()) {
       toast.error("グループ名を入力してください");
       return;
     }
     setLoading(true);
     try {
       const newGroup = await createGroup({
         name: groupName.trim(),
         color: groupColor,
       });
       setSelectedGroupId(newGroup.id);
       toast.success("グループを作成しました");
       router.push("/dashboard");
     } catch (e) {
       if (e instanceof ApiClientError) {
         toast.error(e.message);
       } else {
         toast.error("グループの作成に失敗しました");
       }
     } finally {
       setLoading(false);
     }
   };
   ```

2. **ボタンの `onClick` に `handleCreate` を設定**

3. **作成成功後の挙動**
   - 作成したグループを `setSelectedGroupId` で選択状態にする
   - `/dashboard` に遷移し、新しいグループが一覧に表示される

### 確認ポイント

- [ ] 「作成する」ボタンで API が呼ばれる
- [ ] 成功時にトーストが表示され、ダッシュボードに遷移する
- [ ] ダッシュボードに新しいグループが表示される
- [ ] グループ名未入力で送信するとエラーが表示される
- [ ] 送信中はボタンがローディング状態になる

---

## Stage 5: ダッシュボードに作成ボタンを追加

### 目的

ダッシュボードに「グループを作成」ボタンを配置し、導線を完成させる。

### 修正するファイル

| 種別 | パス |
|------|------|
| 修正 | `src/app/dashboard/page.tsx` |

### 実装内容

1. **グループ一覧の下に「＋ グループを作成」ボタンを追加**
   - `Link href="/groups/new"` で遷移
   - 破線ボーダーのカードスタイル（既存のグループカードと同じ幅・角丸）
   - 中央に「＋」アイコン + 「グループを作成」テキスト
   - 色は控えめ（グレー系ボーダー + テキスト）

2. **スタイル例**
   ```tsx
   <Link
     href="/groups/new"
     className={[
       "w-full rounded-2xl p-5 border-2 border-dashed",
       "border-[#d5d0c8] dark:border-[#3a3835]",
       "flex items-center justify-center gap-2",
       "text-[#9e9a93] dark:text-[#666360]",
       "hover:border-[#c9a227] hover:text-[#c9a227]",
       "transition-all duration-150",
     ].join(" ")}
   >
     <svg viewBox="0 0 24 24" fill="currentColor" width={20} height={20}>
       <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
     </svg>
     <span className="text-base font-semibold">グループを作成</span>
   </Link>
   ```

3. **グループが0件の場合の空状態**
   - グループが 1 件もない場合は「まだグループがありません」というメッセージ + 作成ボタンを表示

### 確認ポイント

- [ ] ダッシュボードの下部に「＋ グループを作成」が表示される
- [ ] クリックで `/groups/new` に遷移する
- [ ] グループ 0 件の場合に空状態メッセージが表示される
- [ ] グループ作成後にダッシュボードに戻ると新しいグループが表示される

---

## 実装フロー図

```
Stage 1          Stage 2          Stage 3          Stage 4          Stage 5
API 実装    →    クライアント  →  UI 作成     →   送信処理     →   導線完成
                 関数追加
                                                                        
POST /api/       createGroup()    /groups/new      handleCreate()   ダッシュボード
groups            apiClient       画面レイアウト    API 呼び出し     「＋」ボタン
route.ts          + 型定義        + カラーピッカー   + 遷移           + 空状態
```

---

## 関連ドキュメント

- 現在の API 仕様: `07-API仕様書.md`
- DB スキーマ: `prisma/schema.prisma`（変更不要）
- 未実装機能一覧: `11-未実装機能一覧.md`
